//@version=5
strategy("Crypto 15m Multi-Layer Trading Strategy v1.0", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.05)

/**
 * ========================================
 * 15分鐘虛擬貨幣超短線交易策略
 * 多層級確認系統 + 風險損益比1:1.5 + 目標夏普比率≈1.0
 * ========================================
 * 核心邏輯：
 * 第一層：趨勢確認層 (MA 多頭/空頭排列)
 * 第二層：動能確認層 (MACD + RSI)
 * 第三層：量能確認層 (成交量 + 型態識別)
 * ========================================
 */

// ============== 參數設定 ==============
group_basic = "基本參數"
group_ma = "均線參數"
group_macd = "MACD參數"
group_rsi = "RSI參數"
group_atr = "ATR參數"
group_risk = "風險管理"
group_filters = "過濾條件"
group_display = "顯示設定"

// 基本參數
initial_capital = input.float(1000, title="初始資金 ($)", group=group_basic)
risk_per_trade = input.float(2.0, title="單筆風險百分比 (%)", minval=0.5, maxval=5, group=group_basic)
risk_reward_ratio = input.float(1.5, title="風險損益比", minval=0.5, maxval=3, group=group_basic)

// MA參數
ma_fast_length = input.int(5, title="快速MA週期", minval=3, maxval=20, group=group_ma)
ma_mid_length = input.int(20, title="中速MA週期", minval=10, maxval=50, group=group_ma)
ma_slow_length = input.int(60, title="慢速MA週期", minval=30, maxval=200, group=group_ma)

// MACD參數
macd_fast = input.int(12, title="MACD快線", minval=5, maxval=35, group=group_macd)
macd_slow = input.int(26, title="MACD慢線", minval=10, maxval=50, group=group_macd)
macd_signal = input.int(9, title="MACD信號線", minval=5, maxval=20, group=group_macd)

// RSI參數
rsi_length = input.int(14, title="RSI週期", minval=5, maxval=50, group=group_rsi)
rsi_overbought = input.float(70, title="RSI超買", minval=50, maxval=90, group=group_rsi)
rsi_oversold = input.float(30, title="RSI超賣", minval=10, maxval=50, group=group_rsi)

// ATR參數
atr_length = input.int(14, title="ATR週期", minval=5, maxval=50, group=group_atr)
atr_mult_stop = input.float(2.0, title="止損ATR倍數", minval=1, maxval=3, group=group_atr)
atr_mult_profit = input.float(3.0, title="止盈ATR倍數", minval=1.5, maxval=5, group=group_atr)

// 風險管理
max_consecutive_losses = input.int(3, title="連續虧損停止筆數", minval=1, maxval=10, group=group_risk)
use_dynamic_stop = input.bool(true, title="使用動態止損(棘輪)", group=group_risk)

// 過濾條件
min_volume_ratio = input.float(1.5, title="最小成交量倍數", minval=1, maxval=3, group=group_filters)
require_divergence = input.bool(false, title="必須要有背離信號", group=group_filters)
require_second_test = input.bool(false, title="必須二次測試", group=group_filters)
atr_volatility_filter = input.bool(true, title="啟用ATR波動率過濾", group=group_filters)
min_atr_ratio = input.float(0.8, title="最小ATR比率(相對基準)", minval=0.5, maxval=1.5, group=group_filters)

// 顯示設定
show_ma = input.bool(true, title="顯示均線", group=group_display)
show_signals = input.bool(true, title="顯示買賣信號", group=group_display)
show_tp_sl = input.bool(true, title="顯示TP/SL", group=group_display)
show_info = input.bool(true, title="顯示策略信息", group=group_display)

// ============== 計算指標 ==============

// 均線
ma_fast = ta.sma(close, ma_fast_length)
ma_mid = ta.sma(close, ma_mid_length)
ma_slow = ta.sma(close, ma_slow_length)

// MACD
[macd_line, macd_signal_line, macd_hist] = ta.macd(close, macd_fast, macd_slow, macd_signal)

// RSI
rsi = ta.rsi(close, rsi_length)

// ATR
atr_val = ta.atr(atr_length)
atr_basis = ta.sma(atr_val, 30)  // 30根K線的ATR平均作為基準
atr_ratio = atr_val / atr_basis

// 成交量
volume_sma = ta.sma(volume, 20)
volume_ratio = volume / volume_sma

// ============== 信號識別邏輯 ==============

// 第一層：趨勢確認
uptrend = ma_fast > ma_mid and ma_mid > ma_slow
downtrend = ma_fast < ma_mid and ma_mid < ma_slow
trend_aligned = uptrend or downtrend

// 第二層：MACD與RSI動能
macd_bullish = ta.crossover(macd_line, macd_signal_line) and macd_hist > 0
macd_bearish = ta.crossunder(macd_line, macd_signal_line) and macd_hist < 0

rsi_bullish = ta.crossover(rsi, 50) and rsi < rsi_overbought
rsi_bearish = ta.crossunder(rsi, 50) and rsi > rsi_oversold

rsi_from_oversold = rsi > rsi_oversold and rsi[1] <= rsi_oversold
rsi_from_overbought = rsi < rsi_overbought and rsi[1] >= rsi_overbought

momentum_bullish = (macd_bullish or rsi_bullish or rsi_from_oversold) and uptrend
momentum_bearish = (macd_bearish or rsi_bearish or rsi_from_overbought) and downtrend

// 第三層：成交量確認
volume_confirmed = volume_ratio > min_volume_ratio

// 底背離（底部反轉信號）
bottom_divergence = close < low[1] and macd_line > macd_line[1] and macd_line[1] < macd_line[2]

// 頂背離（頂部反轉信號）
top_divergence = close > high[1] and macd_line < macd_line[1] and macd_line[1] > macd_line[2]

// ATR波動率過濾
atr_pass = not atr_volatility_filter or atr_ratio >= min_atr_ratio

// ============== 進場條件 ==============

// 多頭進場
long_signal = trend_aligned and uptrend and momentum_bullish and volume_confirmed and atr_pass

// 空頭進場
short_signal = trend_aligned and downtrend and momentum_bearish and volume_confirmed and atr_pass

// ============== 風險管理計算 ==============

// 計算帳戶資金
equity = strategy.equity
account_risk = equity * (risk_per_trade / 100)

// ATR止損計算
stop_distance_long = atr_val * atr_mult_stop
stop_distance_short = atr_val * atr_mult_stop
profit_distance_long = atr_val * atr_mult_profit
profit_distance_short = atr_val * atr_mult_profit

// 進場點
entry_price_long = close
entry_price_short = close

// 止損止盈
stop_loss_long = entry_price_long - stop_distance_long
stop_loss_short = entry_price_short + stop_distance_short
take_profit_long = entry_price_long + profit_distance_long
take_profit_short = entry_price_short - profit_distance_short

// 倉位計算（根據風險額度）
position_size_long = account_risk / stop_distance_long
position_size_short = account_risk / stop_distance_short

// ============== 連續虧損計數 ==============

var int consecutive_losses = 0
var float last_trade_profit = 0

if strategy.losspercent > 0
    consecutive_losses += 1
else if strategy.winstatus == strategy.win
    consecutive_losses = 0

// 超過連續虧損限制則停止交易
trading_allowed = consecutive_losses < max_consecutive_losses

// ============== 執行策略 ==============

// 多頭進場
if long_signal and trading_allowed and strategy.position_size == 0
    strategy.entry("Long", strategy.long, alert_message="LONG Signal: Uptrend + Momentum + Volume")
    
    // 設置止損止盈
    strategy.exit("Long TP/SL", from_entry="Long", stop=stop_loss_long, limit=take_profit_long)

// 空頭進場
if short_signal and trading_allowed and strategy.position_size == 0
    strategy.entry("Short", strategy.short, alert_message="SHORT Signal: Downtrend + Momentum + Volume")
    
    // 設置止損止盈
    strategy.exit("Short TP/SL", from_entry="Short", stop=stop_loss_short, limit=take_profit_short)

// 動態止損（棘輪止損）- 只上移不下移
var float trailing_stop_long = na
var float trailing_stop_short = na

if use_dynamic_stop
    if strategy.position_size > 0  // 多頭持倉
        trailing_stop_long := max(nz(trailing_stop_long, stop_loss_long), close - stop_distance_long)
        strategy.exit("Long Trailing", from_entry="Long", stop=trailing_stop_long)
    
    if strategy.position_size < 0  // 空頭持倉
        trailing_stop_short := min(nz(trailing_stop_short, stop_loss_short), close + stop_distance_short)
        strategy.exit("Short Trailing", from_entry="Short", stop=trailing_stop_short)

// 重置棘輪止損
if strategy.position_size == 0
    trailing_stop_long := na
    trailing_stop_short := na

// ============== 可視化繪製 ==============

// 繪製均線
if show_ma
    plot(ma_fast, title="MA Fast (5)", color=color.blue, linewidth=1)
    plot(ma_mid, title="MA Mid (20)", color=color.orange, linewidth=1)
    plot(ma_slow, title="MA Slow (60)", color=color.red, linewidth=1)

// 繪製買賣信號
if show_signals
    plotshape(long_signal, title="Buy Signal", style=shape.labelup, location=location.belowbar, color=color.green, textcolor=color.white, size=size.small)
    plotshape(short_signal, title="Sell Signal", style=shape.labeldown, location=location.abovebar, color=color.red, textcolor=color.white, size=size.small)

// 繪製進場價格與止損止盈
if show_tp_sl and strategy.position_size != 0
    if strategy.position_size > 0
        plot(entry_price_long, title="Entry Price", color=color.blue, linewidth=2, style=plot.style_linebr)
        plot(stop_loss_long, title="Stop Loss", color=color.red, linewidth=2, style=plot.style_linebr)
        plot(take_profit_long, title="Take Profit", color=color.green, linewidth=2, style=plot.style_linebr)
    else
        plot(entry_price_short, title="Entry Price", color=color.orange, linewidth=2, style=plot.style_linebr)
        plot(stop_loss_short, title="Stop Loss", color=color.red, linewidth=2, style=plot.style_linebr)
        plot(take_profit_short, title="Take Profit", color=color.green, linewidth=2, style=plot.style_linebr)

// ============== 策略信息面板 ==============

if show_info
    // 計算統計數據
    win_rate = (strategy.winstotal / (strategy.winstotal + strategy.losstotal)) * 100
    total_trades = strategy.winstotal + strategy.losstotal
    
    info_text = "
     Equity: " + str.tostring(equity, "$#,##0.00") + "
     Win Rate: " + str.tostring(win_rate, "#0.0") + "%
     Trades: " + str.tostring(total_trades, "0") + "
     Losses: " + str.tostring(consecutive_losses, "0") + "/" + str.tostring(max_consecutive_losses, "0") + "
     ATR Ratio: " + str.tostring(atr_ratio, "#0.00") + "
     RSI: " + str.tostring(rsi, "#0") + "
    "
    
    var table info_table = table.new(position=position.top_right, columns=1, rows=1, bgcolor=color.new(color.black, 80), border_color=color.gray)
    
    table.cell(info_table, 0, 0, text=info_text, text_color=color.white, text_size=size.small)

// ============== 警報設定 ==============

alertcondition(long_signal, title="Long Entry", message="LONG: Uptrend confirmed with momentum and volume")
alertcondition(short_signal, title="Short Entry", message="SHORT: Downtrend confirmed with momentum and volume")
alertcondition(strategy.position_size > 0 and close <= stop_loss_long, title="Long Stop Loss Hit", message="STOP LOSS HIT: Long position")
alertcondition(strategy.position_size < 0 and close >= stop_loss_short, title="Short Stop Loss Hit", message="STOP LOSS HIT: Short position")
